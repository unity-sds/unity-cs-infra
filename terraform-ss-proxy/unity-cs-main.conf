<VirtualHost *:443>
    # Update these with the proper values for the SS Account
    Define PORT_NUM 8443
    Define UNITY_SERVER_NAME unity-shared-services-httpd-server-dev
    Define UNITY_COGNITO_USER_POOL_ID ${COGNITO_POOL_ID}
    Define UNITY_OIDC_CLIENT_ID ${OIDC_CLIENT_ID}
    Define UNITY_OIDC_CLIENT_SECRET ${OIDC_CLIENT_SECRET}
    Define UNITY_OIDC_REDIRECT_URI https://www.dev.mdps.mcp.nasa.gov:${PORT_NUM}/unity/redirect-url
    Define UNITY_OIDC_OIDC_CRYPTO_PASSPHRASE https://www.dev.mdps.mcp.nasa.gov:${PORT_NUM}/unity/redirect-url

    ServerName ${UNITY_SERVER_NAME}
    ServerAlias ${UNITY_SERVER_NAME}
    ServerAdmin postmaster@unity.httpd
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    SSLProxyEngine On
    SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
    SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire on
    SSLProxyCheckPeerName off
    ProxyRequests Off

    OIDCScope "openid email profile"
    OIDCProviderMetadataURL https://cognito-idp.us-west-2.amazonaws.com/${UNITY_COGNITO_USER_POOL_ID}/.well-known/openid-configuration
    OIDCClientID ${UNITY_OIDC_Client_ID}
    OIDCClientSecret ${UNITY_OIDC_CLIENT_SECRET}

    # OIDCRedirectURI is a vanity URL that must point to a path protected by this module but must NOT point to any content
    OIDCRedirectURI ${UNITY_OIDC_REDIRECT_URI}
    OIDCCryptoPassphrase ${UNITY_OIDC_OIDC_CRYPTO_PASSPHRASE}

    # Set max number of state cookies to avoid piling up OIDC state cookies
    OIDCStateMaxNumberOfCookies 3 true

    Define JPL_URL https://www.jpl.nasa.gov/

    # Map the reload-config URL to the actual script
    ScriptAlias /reload-config /usr/lib/cgi-bin/reload-apache.cgi

    # Create the endpoint handler
    <Location /reload-config>
        # Explicitly disable OIDC authentication for this endpoint
        AuthType None
        
        # Use SetEnvIf to check the token and set environment variable
        SetEnvIf X-Reload-Token "^REPLACE_WITH_SECURE_TOKEN$" valid_token
        
        # Require the environment variable to be set
        <RequireAll>
            Require env valid_token
        </RequireAll>

        SetHandler cgi-script
        Options +ExecCGI
    </Location>

    <Location /unity/redirect-url>
        AuthType openid-connect  
        Require valid-user
        # No content needed - OIDC module handles this internally
    </Location>

    ProxyPass "/data/" "http://internal-uds-dev-ds-alb-694766956.us-west-2.elb.amazonaws.com:8005/data/"
    ProxyPassReverse "/data/" "http://internal-uds-dev-ds-alb-694766956.us-west-2.elb.amazonaws.com:8005/data/"

    <Location /data>
        ProxyPreserveHost on
        AuthType openid-connect
        Require valid-user
    </Location>


    ProxyPass "/stac_fast_api/" "http://internal-uds-sbx-ds-alb-1539439526.us-west-2.elb.amazonaws.com:8080/"
    ProxyPassReverse "/stac_fast_api/" "http://internal-uds-sbx-ds-alb-1539439526.us-west-2.elb.amazonaws.com:8080/"
    <Location /stac_fast_api>
        ProxyPreserveHost on
        AuthType openid-connect
        Require valid-user
    </Location>

    # Include all venue configurations (if any)
    IncludeOptional /etc/apache2/venues.d/*.conf

</VirtualHost>